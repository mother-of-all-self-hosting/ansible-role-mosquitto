# SPDX-FileCopyrightText: 2023 Julian-Samuel Geb√ºhr
# SPDX-FileCopyrightText: 2023, 2024 Nikita Chernyi
# SPDX-FileCopyrightText: 2023-2025 Slavi Pantaleev
# SPDX-FileCopyrightText: 2024 Sergio Durigan Junior
# SPDX-FileCopyrightText: 2025 MASH project contributors
# SPDX-FileCopyrightText: 2025, 2026 Suguru Hirahara
#
# SPDX-License-Identifier: AGPL-3.0-or-later

---
# Project source code URL: https://github.com/eclipse-mosquitto/mosquitto

mosquitto_enabled: true

mosquitto_identifier: mosquitto
mosquitto_base_path: "/{{ mosquitto_identifier }}"
mosquitto_config_path: "{{ mosquitto_base_path }}/config"

# renovate: datasource=docker depName=library/eclipse-mosquitto versioning=semver
mosquitto_version: 2.0.22

mosquitto_uid: ""
mosquitto_gid: ""

mosquitto_container_image: "{{ mosquitto_container_image_registry_prefix }}library/eclipse-mosquitto:{{ mosquitto_container_image_tag }}"
mosquitto_container_image_tag: "{{ mosquitto_version }}"
mosquitto_container_image_registry_prefix: "{{ mosquitto_container_image_registry_prefix_upstream }}"
mosquitto_container_image_registry_prefix_upstream: "{{ mosquitto_container_image_registry_prefix_upstream_default }}"
mosquitto_container_image_registry_prefix_upstream_default: docker.io/
mosquitto_container_image_force_pull: "{{ mosquitto_container_image.endswith(':latest') }}"

# The base container network. It will be auto-created by this role if it doesn't exist already.
mosquitto_container_network: "{{ mosquitto_identifier }}"

# Control if the container network is deleted on uninstalling.
mosquitto_container_network_deletion_enabled: true

# Specify how the container publishes its MQTT port (as defined by `mosquitto_container_network`).
#
# Takes an "<ip>:<port>" or "<port>" value (e.g. "127.0.0.1:2586"), or empty string to not expose.
mosquitto_container_mqtt_host_bind_port: "{{ mosquitto_container_mqtt_port }}"

# The port number in the container
mosquitto_container_mqtt_port: 1883

# A list of additional container networks that the container would be connected to.
# The role does not create these networks, so make sure they already exist.
# Use this to expose this container to another reverse proxy, which runs in a different container network.
mosquitto_container_additional_networks: "{{ mosquitto_container_additional_networks_auto + mosquitto_container_additional_networks_custom }}"
mosquitto_container_additional_networks_auto: []
mosquitto_container_additional_networks_custom: []

# Specify the size of the container's tmpfs volume
mosquitto_container_tmpfs_tmp_size: 128m

# A list of extra arguments to pass to the container (`docker create` command)
mosquitto_container_extra_arguments: "{{ mosquitto_container_extra_arguments_auto + mosquitto_container_extra_arguments_custom }}"
mosquitto_container_extra_arguments_auto: []
mosquitto_container_extra_arguments_custom: []

# List of systemd services that the Mosquitto systemd service depends on
mosquitto_systemd_required_services_list: "{{ mosquitto_systemd_required_services_list_default + mosquitto_systemd_required_services_list_auto + mosquitto_systemd_required_services_list_custom }}"
mosquitto_systemd_required_services_list_default: "{{ [devture_systemd_docker_base_docker_service_name] if devture_systemd_docker_base_docker_service_name else [] }}"
mosquitto_systemd_required_services_list_auto: []
mosquitto_systemd_required_services_list_custom: []

# List of systemd services that the Mosquitto systemd service wants
mosquitto_systemd_wanted_services_list: "{{ mosquitto_systemd_wanted_services_list_default + mosquitto_systemd_wanted_services_list_auto + mosquitto_systemd_wanted_services_list_custom }}"
mosquitto_systemd_wanted_services_list_default: []
mosquitto_systemd_wanted_services_list_auto: []
mosquitto_systemd_wanted_services_list_custom: []

# Controls how long to wait for the container to stop gracefully before killing it.
mosquitto_container_stop_grace_time_seconds: "{{ devture_systemd_docker_base_container_stop_grace_time_seconds }}"

# Controls how long the pre-start cleanup should wait for stale container-name release
# before failing startup explicitly.
mosquitto_container_cleanup_timeout_seconds: "{{ devture_systemd_docker_base_container_cleanup_timeout_seconds }}"

# Controls the delay between pre-start cleanup retries.
mosquitto_container_cleanup_retry_delay_seconds: "{{ devture_systemd_docker_base_container_cleanup_retry_delay_seconds }}"

# Shell command used in the systemd pre-start phase to deterministically remove a stale
# container and wait until Docker releases its name.
mosquitto_container_cleanup_command: |
  i=0;
  while [ "$i" -lt {{ mosquitto_container_cleanup_timeout_seconds }} ]; do
  {{ devture_systemd_docker_base_host_command_docker }} stop -t {{ mosquitto_container_stop_grace_time_seconds }} {{ mosquitto_identifier }} >/dev/null 2>&1 || true;
  {{ devture_systemd_docker_base_host_command_docker }} rm -f {{ mosquitto_identifier }} >/dev/null 2>&1 || true;
  if {{ devture_systemd_docker_base_host_command_docker }} container inspect {{ mosquitto_identifier }} >/dev/null 2>&1; then
  i=$((i + 1));
  sleep {{ mosquitto_container_cleanup_retry_delay_seconds }};
  continue;
  fi;
  if {{ devture_systemd_docker_base_host_command_docker }} info >/dev/null 2>&1; then
  exit 0;
  fi;
  echo "Failed to query Docker daemon while cleaning up {{ mosquitto_identifier }}" >&2;
  exit 1;
  done;
  echo "Failed to remove stale container {{ mosquitto_identifier }} after {{ mosquitto_container_cleanup_timeout_seconds }} attempts" >&2;
  exit 1

# Allow everyone to use your MQTT brocker
# Change only when you understand the implications!
# See https://mosquitto.org/documentation/authentication-methods/
mosquitto_allow_anonymous_access: false

# Make use of a password file
mosquitto_use_password_file: true
mosquitto_container_password_file_location: "/mosquitto/config/password_file"

# Specify the timezone
mosquitto_environment_variables_tz: UTC

# Additional environment variables.
mosquitto_environment_variables_additional_variables: ""
